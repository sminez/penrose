<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Data Structures - The Penrose Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="../getting-started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../builtin/index.html"><strong aria-hidden="true">2.</strong> Built In Functionality</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../builtin/layouts.html"><strong aria-hidden="true">2.1.</strong> Layouts</a></li><li class="chapter-item expanded "><a href="../builtin/actions.html"><strong aria-hidden="true">2.2.</strong> Actions</a></li><li class="chapter-item expanded "><a href="../builtin/ui.html"><strong aria-hidden="true">2.3.</strong> UI</a></li></ol></li><li class="chapter-item expanded "><a href="../extensions/index.html"><strong aria-hidden="true">3.</strong> Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/hooks.html"><strong aria-hidden="true">3.1.</strong> Hooks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/startup-hooks.html"><strong aria-hidden="true">3.1.1.</strong> Startup Hooks</a></li><li class="chapter-item expanded "><a href="../extensions/event-hooks.html"><strong aria-hidden="true">3.1.2.</strong> Event Hooks</a></li><li class="chapter-item expanded "><a href="../extensions/manage-hooks.html"><strong aria-hidden="true">3.1.3.</strong> Manage Hooks</a></li><li class="chapter-item expanded "><a href="../extensions/refresh-hooks.html"><strong aria-hidden="true">3.1.4.</strong> Refresh Hooks</a></li></ol></li><li class="chapter-item expanded "><a href="../extensions/ewmh.html"><strong aria-hidden="true">3.2.</strong> EWMH</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Reference Guide</li><li class="chapter-item expanded "><a href="../overview/index.html"><strong aria-hidden="true">4.</strong> Overview of Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../overview/pure-vs-x.html"><strong aria-hidden="true">4.1.</strong> Pure Code vs X Code</a></li><li class="chapter-item expanded "><a href="../overview/data-structures.html" class="active"><strong aria-hidden="true">4.2.</strong> Data Structures</a></li></ol></li><li class="chapter-item expanded "><a href="../building/index.html"><strong aria-hidden="true">5.</strong> Building on top of penrose</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building/actions.html"><strong aria-hidden="true">5.1.</strong> Actions</a></li><li class="chapter-item expanded "><a href="../building/layouts.html"><strong aria-hidden="true">5.2.</strong> Layouts</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Hooks</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> State Extensions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Example: Named Scratchpads</div></li></ol></li><li class="chapter-item expanded "><a href="../faq.html">FAQs</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Penrose Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><image width="50px" src="https://raw.githubusercontent.com/sminez/penrose/develop/icon.svg" align="left"></image></p>
<h1 id="data-structures"><a class="header" href="#data-structures">Data Structures</a></h1>
<p>As mentioned in <a href="./pure-vs-x.html">Pure Code vs X Code</a>, there are a number of <code>pure</code> data structures that penrose makes use of
in order to manage the internal state of the window manager. We wont get too much into the details of all of the
various methods associated with each data structure: for that it's best to read the docs on docs.rs. Instead,
we'll take a quick look at what each data structure does and how you can make use of it when writing your own
penrose based window manager.</p>
<p>Most of the data structures outlines below are some form of <a href="https://en.wikipedia.org/wiki/Zipper_(data_structure)">zipper</a> (or some meta-data wrapped around a zipper).
If the Wikipedia page all looks a bit "computer science-y" to you then you can get by pretty well by thinking of
a zipper as collection type (like a list or a tree) that has an added concept of "focus" (that is, "the element
of the collection we are currently looking at"). There is a really nice article about <a href="https://donsbot.com/2007/05/17/roll-your-own-window-manager-tracking-focus-with-a-zipper/">the use of zippers in Xmonad</a>
which is worth a read if you have the time. It covers the starting point for the use of zippers in penrose and
also shows where all of the names come from(!) Penrose takes the idea a little further than what is seen in
Xmonad in order to provide what I think is a nicer API to work with (but I'll let you be the judge of that).</p>
<p>First up, the arguably incorrectly named "Stack".</p>
<h3 id="stacks"><a class="header" href="#stacks">Stacks</a></h3>
<p>So called because it (primarily) represents the X "window stack" for the current screen you are looking at. Getting
technical for a minute, a <code>Stack</code> is a zipper over a <a href="https://doc.rust-lang.org/std/collections/struct.LinkedList.html">doubly-linked list</a> that has a couple of nice properties
that help to simplify how a lot of the rest of the code in penrose is written:</p>
<ol>
<li>A Stack is <em>never</em> empty (there is always at least the focused element)</li>
<li>Operations that manipulate which element is focused do not alter the <em>order</em> of the elements themselves.</li>
<li>Operations that work with the focused element are <code>O(1)</code></li>
</ol>
<p>You can think of a <code>Stack</code> as simply being a normal linked list with a flag on one of the elements to indicate
where the focus point currently sits. (The actual implementation is a little different in order to make things
nicer to work with but the idea itself is fine).</p>
<p>Penrose makes use of <code>Stacks</code> for anything that we want to track focus for. Specifically, we use them for tracking:</p>
<ul>
<li>windows assigned to each workspace</li>
<li>the layouts in use on each workspace</li>
<li>workspaces assigned to a each screen</li>
</ul>
<p>The operations available on <code>Stacks</code> are pretty much what you'd expect: you can treat them like collections (map,
filter, re-order the elements, iterate, etc) and you can move the focus point around.</p>
<h3 id="workspaces"><a class="header" href="#workspaces">Workspaces</a></h3>
<p>Up next after <code>Stacks</code> is <code>Workspaces</code>. You can think of a workspace as a wrapper around a given window stack that
helps penrose know how to locate the given stack of clients and how (and when) to position them on the screen.
Rust type wise, a workspace look like this (the fields on a real <code>Workspace</code> aren't public but we can ignore that for now):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Workspace {
    id: usize,
    tag: String,
    layouts: Stack&lt;Layout&gt;,
    stack: Option&lt;Stack&lt;Xid&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>id</code> and <code>tag</code> fields are used to identify workspaces within the larger pure state: useful, but not particularly
interesting. The client <code>Stack</code> itself is wrapped in an Option because (like we mentioned above) there is no such
thing as an empty <code>Stack</code>, so a <code>Workspace</code> with no windows has <code>None</code>. Running operations on the stack contained in
a given workspace is possible from the top level of the pure state (which we'll cover in a bit).</p>
<p>The <code>layouts</code> field contains all of the possible <a href="./layouts.html">Layout</a> algorithms available for positioning windows on this
workspace. There must be at least one layout available (so no <code>Option&lt;Stack&gt;</code> here) and the currently focused layout
in the stack is the one that will be used to position windows when this workspace is placed on a given screen.</p>
<p>Speaking of which...</p>
<h3 id="screens"><a class="header" href="#screens">Screens</a></h3>
<p>If you thought a <code>Workspace</code> was pretty much "a window Stack with a fancy hat", then a <code>Screen</code> is "a Workspace in a
box".</p>
<p>A 2D box to be precise.</p>
<p>For the purposes of our pure state, all we care about when it comes to the physical screens we have to play with are:</p>
<ul>
<li>which screen we're talking about</li>
<li>the dimensions of the screen</li>
<li>the workspace that is currently active</li>
</ul>
<p>Each screen pairs a <code>Workspace</code> with an ID (<code>0..n</code> in the order that they are returned to us by the X server) and a
<code>Rect</code> to denote the size and relative position of each screen in pixels. Workspaces can be moved between screens,
clients can be moved between workspaces.</p>
<p>Lovely.</p>
<h4 id="rectangles"><a class="header" href="#rectangles">Rect(angles)</a></h4>
<p>Both screens and the windows that sit within them are described using rectangles. Each <code>Rect</code> is simply the <code>(x, y)</code>
coordinates of its top left corner along with its width and height. Not <em>massively</em> exciting on its own but it's
worth taking a look at the docs on the <code>Rect</code> struct to see what methods are available for slicing, dicing, positioning
and comparing Rects while you write your custom Layout algorithms and extensions.</p>
<h3 id="the-stackset"><a class="header" href="#the-stackset">The StackSet</a></h3>
<p>And last but by no means least, we have the <code>StackSet</code>. It's a <em>little</em> "set-y" when you break it down so that's what
we're going for name wise until someone gives me something better (it's definitely a lot <em>more</em> like a set than the
original from Xmonad in my opinion but we'll get to that in a second).</p>
<p>Ignoring several book-keeping fields which we maintain for quality of life purposes, the Rust type looks something like
this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct StackSet {
    screens: Stack&lt;Screen&gt;,
    hidden: LinkedList&lt;Workspace&gt;,
    // and some book-keeping...
}
<span class="boring">}</span></code></pre></pre>
<p>I'm not quite sure how best to describe what's going on here in terms of Zippers as it's a <em>little</em> bit of an abuse of
the concept but, if you squint hard enough, what you're looking at is pretty much a "Stack of Stacks". Albeit with a
healthy sprinkling of meta-data throughout and the fact that for the unfocused elements we don't care about their order
(hence the <a href="https://en.wikipedia.org/wiki/Set_(mathematics)">set</a> based name).</p>
<p>If you think back to what we said a <code>Zipper</code> was, we said we had some collection of elements along with the idea of there
being a "focus point" that picks out an element from that collection. For the <code>StackSet</code>, the collection is a set of
<code>Workpsaces</code>, and the "focus" is actually a <code>Stack</code> of <code>Screens</code> and their <em>associated</em> <code>Workspaces</code>.</p>
<p>...still with me?</p>
<p>If you think about what we care about when managing windows, we can break things down into the following:</p>
<ul>
<li>The windows we are managing (<code>Stacks</code>)</li>
<li>The workspaces those windows are assigned to (<code>Workspaces</code>)</li>
<li>The screens those workspaces are shown on (<code>Screens</code>)</li>
<li>The workspaces that are currently hidden from view (more <code>Workspaces</code>)</li>
</ul>
<p>For the workspaces that are visible, we move them in and out of the available screens as needed and we maintain the
currently focused screen which is where the X input focus currently lies. For the hidden workspaces we don't really care
about what order they are in (we can't see them) so we use a LinkedList to store anything not currently allocated to a
screen.</p>
<blockquote>
<p>We <em>could</em> use a <code>HashSet</code> but then we'd need Workspaces to be hashable and it doesn't actually buy us much in terms
of the API we end up with.</p>
</blockquote>
<p>Having the focused "element" be another level of wrapping around <em>multiple</em> element from the collection really pushes
the definiton of a Zipper I suspect but it works pretty nicely all things considered. We can then fully manage the
on screen position and stack position of each window and manipulate groups of windows based on the workspace they are
part of.</p>
<p>Nice.</p>
<h3 id="and-thats-it"><a class="header" href="#and-thats-it">And that's it!</a></h3>
<p>Admittedly, "it" is a rather large set of methods on a <code>StackSet</code> but it gives you a rich, zipper based API for manipulating
your windows which handles all of the focus book-keeping for you. To really understand everything that is possible with
the API it is best to dive into the docs.rs docs and try things out for yourself. The <em>real</em> structs are generic rather
than having to contain <code>Xids</code> as shown in the pseudo-code above so feel free to pull in penrose as a dependency and start
having a play with them to see what is possible!</p>
<p>The tests suites are another good place to take a look at how things work without getting too tied up in the specific use
cases penrose has for things.</p>
<p>Speaking of specifics, lets take a look at how to actually do useful things with your window manager: up next we're covering
layouts.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../overview/pure-vs-x.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../building/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../overview/pure-vs-x.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../building/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
